#!/usr/bin/env bash
# RubyCritic Quality Gate
# Fails on F grades initially, can be tightened to D/F later

set -e

echo "ğŸ” Running RubyCritic analysis..."

# Run RubyCritic and capture output
bundle exec rubycritic --mode console --no-browser > tmp/rubycritic.txt 2>&1

# Extract the score
score=$(grep -Eo 'Score: [0-9]+\.[0-9]+' tmp/rubycritic.txt | awk '{print $2}' || echo "0")
echo "ğŸ“Š RubyCritic score: $score"

# Check for F grades (fail on F initially)
if grep -q "grade: F" tmp/rubycritic.txt; then
  echo "âŒ F grade files found:"
  grep -B2 -A1 "grade: F" tmp/rubycritic.txt
  echo ""
  echo "ğŸ’¡ Fix F grade files before proceeding"
  exit 1
fi

# Check for D grades (warn but don't fail initially)
if grep -q "grade: D" tmp/rubycritic.txt; then
  echo "âš ï¸  D grade files found (warning only):"
  grep -B2 -A1 "grade: D" tmp/rubycritic.txt
  echo ""
  echo "ğŸ’¡ Consider fixing D grade files in future iterations"
fi

echo "âœ… RubyCritic gate passed (no F grades)"
