#!/usr/bin/env bash

# Intentia API Development Setup Script

echo "ðŸš€ Starting Intentia API development environment..."

# Check if Redis is running
if ! redis-cli ping > /dev/null 2>&1; then
    echo "âš ï¸  Redis is not running. Please start Redis first:"
    echo "   redis-server"
    echo ""
    echo "Or install Redis if you haven't:"
    echo "   brew install redis  # macOS"
    echo "   sudo apt-get install redis-server  # Ubuntu"
    exit 1
fi

echo "âœ… Redis is running"

# Start Sidekiq in background
echo "ðŸ”„ Starting Sidekiq..."
bundle exec sidekiq &
SIDEKIQ_PID=$!

# Start Rails server
echo "ðŸš€ Starting Rails server..."
echo ""
echo "API will be available at: http://localhost:3000"
echo ""
echo "Health check endpoints:"
echo "  GET  /health/live"
echo "  GET  /health/ready"
echo ""
echo "API endpoints:"
echo "  POST   /api/v1/auth/sign_up"
echo "  POST   /api/v1/auth/sign_in"
echo "  DELETE /api/v1/auth/sign_out"
echo ""
echo "  GET    /api/v1/lists"
echo "  POST   /api/v1/lists"
echo "  GET    /api/v1/lists/:id"
echo "  PATCH  /api/v1/lists/:id"
echo "  DELETE /api/v1/lists/:id"
echo ""
echo "  GET    /api/v1/lists/:list_id/tasks"
echo "  POST   /api/v1/lists/:list_id/tasks"
echo "  PATCH  /api/v1/lists/:list_id/tasks/:id"
echo "  DELETE /api/v1/lists/:list_id/tasks/:id"
echo ""
echo "  POST   /api/v1/devices"
echo ""
echo "Press Ctrl+C to stop all services"

# Function to cleanup background processes
cleanup() {
    echo ""
    echo "ðŸ›‘ Stopping services..."
    kill $SIDEKIQ_PID 2>/dev/null
    echo "âœ… All services stopped"
    exit 0
}

# Set trap to cleanup on exit
trap cleanup SIGINT SIGTERM

# Start Rails server
bundle exec rails server