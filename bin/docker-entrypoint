#!/bin/bash -e

echo "=== Starting entrypoint ==="
echo "PORT: $PORT"
echo "RAILS_ENV: $RAILS_ENV"
echo "DATABASE_URL present: ${DATABASE_URL:+yes}"

# Enable jemalloc
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

echo "=== Running db:prepare ==="
./bin/rails db:prepare

echo "=== Starting Puma ==="
exec bundle exec puma -C config/puma.rb
